<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Guitar Tuner" />
<link rel="manifest" href="manifest.json" />
<title>Guitar Tuner</title>
<style>
  /* (Same CSS as before, including pulsing halo) */
  body {
    background: #111;
    color: #fff;
    font-family: sans-serif;
    text-align: center;
    padding-top: 50px;
    transition: background 0.4s ease;
  }
  #note {
    font-size: 4em;
    margin-bottom: 10px;
  }
  #cents {
    font-size: 1.5em;
    margin-bottom: 40px;
  }
  .needle-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin: auto;
    border: 4px solid #333;
    border-radius: 50%;
  }
  .needle {
    position: absolute;
    bottom: 50%;
    left: 50%;
    width: 4px;
    height: 90px;
    background: #f43f5e;
    transform-origin: bottom center;
    transform: rotate(0deg);
    transition: transform 0.08s linear;
  }
  body.locked-in {
    animation: haloPulse 1.6s ease-in-out infinite;
  }
  @keyframes haloPulse {
    0% {
      background: radial-gradient(circle at center, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0) 70%);
    }
    50% {
      background: radial-gradient(circle at center, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0) 70%);
    }
    100% {
      background: radial-gradient(circle at center, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0) 70%);
    }
  }
</style>
</head>
<body>
  <div id="note">--</div>
  <div id="cents">0¢</div>
  <div class="needle-container">
    <div class="needle" id="needle"></div>
  </div>

<script>
  let audioContext, analyser, pitchDetector, micStream;
  let needle = document.getElementById('needle');
  let noteName = document.getElementById('note');
  let centsText = document.getElementById('cents');

  let smoothingFactor = 0.2;
  let smoothedCents = 0;
  let lockInTimer = 0;
  let lockedIn = false;
  let bouncePhase = 0;

  const noteStrings = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  async function init() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(micStream);
    source.connect(analyser);

    const { PitchDetector } = await import("https://cdn.jsdelivr.net/npm/pitchy@latest/dist/pitchy.esm.js");
    pitchDetector = PitchDetector.forFloat32Array(analyser.fftSize);
    loop();
  }

  function freqToNoteNumber(frequency) {
    return Math.round(12 * (Math.log(frequency / 440) / Math.log(2))) + 69;
  }
  function noteNumberToName(note) {
    return noteStrings[note % 12];
  }
  function centsOffFromPitch(frequency, note) {
    return Math.floor(1200 * Math.log(frequency / noteToFrequency(note)) / Math.log(2));
  }
  function noteToFrequency(note) {
    return 440 * Math.pow(2, (note - 69) / 12);
  }

  function loop() {
    const input = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(input);
    const [pitch, clarity] = pitchDetector.findPitch(input, audioContext.sampleRate);

    if (clarity > 0.9 && pitch > 20 && pitch < 2000) {
      const note = freqToNoteNumber(pitch);
      const detune = centsOffFromPitch(pitch, note);

      smoothedCents += (detune - smoothedCents) * smoothingFactor;

      noteName.textContent = noteNumberToName(note);
      centsText.textContent = `${Math.round(smoothedCents)}¢`;

      let displayCents = smoothedCents;
      if (lockedIn) {
        displayCents += Math.sin(bouncePhase) * 2;
        bouncePhase += 0.2;
      }
      needle.style.transform = `rotate(${displayCents}deg)`;

      if (Math.abs(smoothedCents) <= 5) {
        centsText.style.color = '#10b981';
        lockInTimer += 16;
        if (lockInTimer >= 400 && !lockedIn) {
          lockedIn = true;
          bouncePhase = 1;
          document.body.classList.add('locked-in');
          noteName.style.transition = 'color 0.3s ease';
          noteName.style.color = '#10b981';
          setTimeout(() => noteName.style.color = '', 600);
        }
      } else {
        document.body.classList.remove('locked-in');
        lockInTimer = 0;
        lockedIn = false;
        bouncePhase = 0;
        centsText.style.color = '';
      }
    }
    requestAnimationFrame(loop);
  }

  init();
</script>

<script>
  // Register Service Worker for offline support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => {
      console.log('Service Worker Registered');
    }).catch(err => {
      console.error('Service Worker registration failed:', err);
    });
  }
</script>
</body>
</html>